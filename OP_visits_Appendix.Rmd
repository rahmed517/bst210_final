---
title: 'Section 5: Outpatient Visits Model'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
medicare <- read_csv("data/medicare_2007_2018.csv")
medicare$expansion_status <- factor(medicare$expansion_status)
```  

We built a similar model to the emergency department visits model to model the relationship between outpatient visits per 1,000 beneficiaries and Medicaid Expansion status.  We added potential covariates one by one and evaluated the fit using likelihood ratio tests, with the intention of getting the best fit possible with this data. We did not identify any of these covariates as potentially confounding the relationship between the outpatient visit rate and Medicaid expansion status.  

### Check distribution of outcome  

```{r}
medicare %>% 
  ggplot(aes(x= op_visits_per_1000_beneficiaries)) +
  geom_histogram(color = "black") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  xlab("Outpatient Visits per 1,000 Beneficiaries") +
  ylab("Count") +
  ggtitle("Distribution of Outpatient Visit Rates (2007-2018)") +
  theme_bw()
```    
The outcome is pretty right skewed.  

We next check missingness in the outcome  

```{r}
medicare %>% 
  select(op_visits_per_1000_beneficiaries) %>% 
  summarize_all(.funs = function(x) 
    return(paste0(round(sum(is.na(x))/length(x), 3)*100, "%"))) %>% 
  t() %>% data.frame() 
```


### Model Fitting      

First we fit the base model:  
```{r}
mod.nb_op<- MASS::glm.nb( op_visits_per_1000_beneficiaries ~ percent_eligible_for_medicaid +  offset(log(year)), data = medicare)

summary(mod.nb_op)

# Model diagnostics table
model_diagnostics <- data.frame(
  Model = "OP Visits ~ Exp",
  AIC = AIC(mod.nb_op),
  BIC = BIC(mod.nb_op)
)
```  

#### Improve Model Fit Using Other Covariates 

The covariates percent_male, percent_eligible_for_medicaid, average_age, do not satisfy the criteria for confounding the relationship between Medicaid Expansion status and Outpatient Visit rates, so we will add each of these covariates one by one to determine if they improve the model fit using Likelihood Ratio tests.  

###### Percent Male

```{r}
mod.nb_op_c1 <- MASS::glm.nb(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + offset(log(year)), data = medicare)
summary(mod.nb_op_c1)           

# Use Likelihood Ratio test to determine if confounder is necessary
anova(mod.nb_op, mod.nb_op_c1) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "OP Visits ~ Exp + Male",
    AIC = AIC(mod.nb_op_c1),
    BIC = BIC(mod.nb_op_c1)
    )
  )

```    

By the LRT, we add percent male into the model.  

###### Percent Eligible for Medicaid
```{r}
mod.nb_op_c2 <- MASS::glm.nb(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + offset(log(year)), data = medicare)
summary(mod.nb_op_c2)           

# Use Anova to determine if confounder is necessary
anova(mod.nb_op_c1, mod.nb_op_c2) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "OP Visits ~ Exp + Male + % Elig",
    AIC = AIC(mod.nb_op_c2),
    BIC = BIC(mod.nb_op_c2)
    )
  )

```    

By the LRT, we add percent eligible for medicaid to the model.  

###### Average Age
```{r}
mod.nb_op_c3 <- MASS::glm.nb(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + offset(log(year)), data = medicare)
summary(mod.nb_op_c3)           

# Use Likelihood ratio test to determine if covariate is necessary
anova(mod.nb_op_c2, mod.nb_op_c3) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "OP Visits ~ Exp + Male + % Elig + Age",
    AIC = AIC(mod.nb_op_c3),
    BIC = BIC(mod.nb_op_c3)
    )
  )
```    

By the LRT, we add average age to the model.  

##### Check for quadratic effects of `percent_eligible_for_medicaid`   
```{r}
mod.nb_op_1 <- MASS::glm.nb(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + percent_eligible_for_medicaid_2 + offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))

summary(mod.nb_op_1)
anova(mod.nb_op_c3, mod.nb_op_1) # Yes 

model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "OP Visits ~ Exp + Male + % Elig + Age + % Elig^2",
    AIC = AIC(mod.nb_op_1),
    BIC = BIC(mod.nb_op_1)
    )
  )
```       

#### Effect Modification  

We think there may be effect modification between % eligible for medicaid and expansion status, since in general Medicaid expansion means a higher percentage of the population qualifies for Medicaid.  

```{r}
mod.nb_op_2 <- MASS::glm.nb(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + percent_eligible_for_medicaid_2  + percent_eligible_for_medicaid*expansion_status+ offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))

summary(mod.nb_op_2)

anova(mod.nb_op_1, mod.nb_op_2)

model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "OP Visits ~ Exp + Male + % Elig + Age + % Elig^2 + % Elig*Exp",
    AIC = AIC(mod.nb_op_2),
    BIC = BIC(mod.nb_op_2)
    )
  )
```     

By the LRT, we do add the interaction between Medicaid expansion status and percent_eligible_for_medicaid.  

#### Model Diagnostics  


```{r}
model_diagnostics
```      
We have the smallest AIC and BIC with the full model.

##### Check Poisson model  

```{r}
mod.pois_ed <- glm(op_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + percent_eligible_for_medicaid_2  + percent_eligible_for_medicaid*expansion_status+ offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2), family = "poisson")

# Evaluate overdispersion
deviance(mod.pois_ed)/mod.pois_ed$df.residual # 604.9794
pearson.stat_ed <- sum((na.omit(medicare %>% select(percent_male, percent_eligible_for_medicaid, average_age,op_visits_per_1000_beneficiaries, expansion_status))$op_visits_per_1000_beneficiaries - fitted(mod.pois_ed))^2/fitted(mod.pois_ed))
pearson.stat_ed/mod.pois_ed$df.residual #  633.6993

# Evidence of overdispersion 
mean(medicare$op_visits_per_1000_beneficiaries, na.rm = T) 
var(medicare$op_visits_per_1000_beneficiaries, na.rm = T)  
```   

Due to the evidence of dispersion, the negative binomial model seems to be the appropriate appropriate model.  


#### Interpretation  

```{r}
exp(coef(mod.nb_op_2))
exp(confint(mod.nb_op_2))
```  