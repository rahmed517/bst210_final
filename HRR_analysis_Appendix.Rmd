---
title: 'Medicaid Expanion: PQI Models'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)

hrr <- read_csv("data/hrr_all_years.csv")
hrr$expansion_status <- factor(hrr$expansion_status)
```

### PQIs of Interest  

For these models, we will be looking at modeling the relationship between various PQIs at the HRR (hospital-referral region) level and Medicaid expansion status. We will be adjusting this relationship using average age of the Medicare population, percent male, percent non-hispanic white, percent african american, percent hispanic, percent eligible for medicaid, and the age category referred to in the PQI. 

### Exploratory analysis on covariates  

First we quantify the missingness in the covariates and outcomes:  

```{r}
tbl <- hrr %>% 
  select(hrr, average_age, percent_male, `percent_non-hispanic_white`, percent_african_american, percent_hispanic, percent_eligible_for_medicaid, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)`, `pqi07_hypertension_admission_rate_(age_<_65)`,`pqi07_hypertension_admission_rate_(age_65-74)`,  `pqi07_hypertension_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_65-74)`, `pqi08_chf_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_<_65)`) %>% 
  summarize_all(.funs = function(x) return(paste0(round(sum(is.na(x))/length(x), 3)*100, "\\%"))) %>% t() %>% data.frame() 

names(tbl) <- c("% of Missing values")
kableExtra::kable(tbl)
```  

We have a very small percentage of missing data in our target covariates and 2 of the 3 PQIs. We believe PQI05 and PQI08 will be reasonable metrics to evaluate outpatient quality and it's relation to Medicaid expansion.

#### Check correlaton in the covariates

```{r}

# hrr, average_age, percent_male, `percent_non-hispanic_white`, percent_african_american, percent_hispanic, percent_eligible_for_medicaid, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)`, `pqi07_hypertension_admission_rate_(age_<_65)`,`pqi07_hypertension_admission_rate_(age_65-74)`,  `pqi07_hypertension_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_65-74)`, `pqi08_chf_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_<_65)`

 hrr %>% 
  select(average_age, percent_male, `percent_non-hispanic_white`, percent_african_american, percent_hispanic, percent_eligible_for_medicaid) %>% na.omit() %>% cor() %>% corrplot::corrplot(method = "color")

plot_histogram <- function(df, var) {
  df %>% ggplot(aes_string(x = var)) +
    geom_histogram(bins = 20) +
    theme_bw() %>% return()
}
```  

Based on the correlation plot, I will remove percent non-hispanic white and average age from the model. I'll redo the correlation plot without those variables.  

```{r}
hrr %>% 
  select(percent_male, percent_african_american, percent_hispanic, percent_eligible_for_medicaid) %>% na.omit() %>% cor() %>% corrplot::corrplot(method = "color")
```  

### Check distribution of outcomes  

#### PQI05  


```{r}
hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)`) %>% 
  gather(age, pqi05, -year) %>% 
  mutate(
    age = str_sub(age, -10)
  ) %>% ggplot(aes( x = pqi05)) + geom_histogram(color = "black") + theme_bw()

# Check number of missing values
hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)`) %>% 
  gather(age, pqi05, -year) %>% pull(pqi05) %>% .[is.na(.)] %>% length()

```  

With only 4 missing values, we'll continue with a complete case analysis for this variable 


#### PQI08

```{r}
hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, `pqi08_chf_admission_rate_(age_65-74)`, `pqi08_chf_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_<_65)`) %>% 
  gather(age, pqi08, -year) %>% 
  mutate(
    age = str_sub(age, -10)
  ) %>% ggplot(aes( x = pqi08)) + geom_histogram(color = "black") + theme_bw()

# Check number of missing values
hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, `pqi08_chf_admission_rate_(age_65-74)`, `pqi08_chf_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_<_65)`) %>% 
  gather(age, pqi08, -year) %>% pull(pqi08) %>% .[is.na(.)] %>% length()

```    

With only 29 missing values, we'll continue with a complete case analysis for this variable. This outcome is almost bi-modally distributed and not normal.  


### Model Fitting  

#### PQI05

Since these variables are rates, we will want to use Poisson models. There may be overdispersion, so I'm going to start fitting a negative binomial and then check if the poisson version has overdispersion.  

```{r}
pqi05_data <- hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, hrr, state, expansion_status,  percent_male, percent_african_american, `percent_hispanic`, percent_eligible_for_medicaid,`pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)`, `pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)`) %>% 
  gather(age, pqi05, c("pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_40-64)", "pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_65-74)", "pqi05_copd_or_asthma_in_older_adults_admission_rate_(age_75+)")) %>% 
  mutate(age = str_extract(age, "(?<=age_).+(?=\\))"))


mod.nb_pqi05 <- MASS::glm.nb(pqi05 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + offset(log(year)), data = pqi05_data)
summary(mod.nb_pqi05)
```    

##### Check for quadratic effects of `percent_eligible_for_medicaid`  

```{r}
mod.nb_pqi05_1 <- MASS::glm.nb(pqi05 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ offset(log(year)), data = pqi05_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))
summary(mod.nb_pqi05_1)
```  





#### Effect Modification  

We think there may be effect modification between % eligible for medicaid and expansion status, since in general Medicaid expansion means a higher percentage of the population qualifies for Medicaid.  

```{r}
mod.nb_pqi05_2 <-MASS::glm.nb(pqi05 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ expansion_status*percent_eligible_for_medicaid + offset(log(year)), data = pqi05_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))
summary(mod.nb_pqi05_2 )
```  

The coefficients for the interaction are significant, so we will keep it in the model. 


#### Model Diagnostics  


```{r}
pqi05_data %>% 
  na.omit() %>% 
  ggplot(aes(x = pqi05, y = fitted(mod.nb_pqi05_2))) +
  geom_point(alpha = 0.7) +
  geom_smooth() +
  theme_bw()
```  

##### Check Poisson model  

```{r}
mod.pois_pqi05 <- glm(pqi05 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ expansion_status*percent_eligible_for_medicaid, offset = log(year), data = pqi05_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2), family = "poisson")

# Evaluate overdispersion
deviance(mod.pois_pqi05)/mod.pois_pqi05$df.residual #  138.7201
pearson.stat_pqi05 <- sum((na.omit(pqi05_data)$pqi05 - fitted(mod.pois_pqi05))^2/fitted(mod.pois_pqi05))
pearson.stat_pqi05/mod.pois_pqi05$df.residual # 144.1579

# Evidence of overdispersion 
mean(pqi05_data$pqi05, na.rm = T) # 1249.904
var(pqi05_data$pqi05, na.rm = T) # 325943.6
```  

By these, we can say the negative binomial is the right choice.   


#### Interpretation  

```{r}
coef(mod.nb_pqi05_2)
exp(confint(mod.nb_pqi05_2))
```    


#### PQI08

Since these variables are rates, we will want to use Poisson models. There may be overdispersion, so I'm going to start fitting a negative binomial and then check if the poisson version has overdispersion.  

```{r}
pqi08_data <- hrr %>% 
  filter(!is.na(expansion_status)) %>% 
  select(year, hrr, state, expansion_status,  percent_male, percent_african_american, `percent_hispanic`, percent_eligible_for_medicaid,`pqi08_chf_admission_rate_(age_65-74)`, `pqi08_chf_admission_rate_(age_75+)`, `pqi08_chf_admission_rate_(age_<_65)`) %>% 
  gather(age, pqi08, c("pqi08_chf_admission_rate_(age_<_65)", "pqi08_chf_admission_rate_(age_65-74)", "pqi08_chf_admission_rate_(age_75+)")) %>% 
  mutate(age = str_extract(age, "(?<=age_).+(?=\\))"))


mod.nb_pqi08 <- MASS::glm.nb(pqi08 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + offset(log(year)), data = pqi08_data)
summary(mod.nb_pqi08)
```    

##### Check for quadratic effects of `percent_eligible_for_medicaid`  

```{r}
mod.nb_pqi08_1 <- MASS::glm.nb(pqi08 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ offset(log(year)), data = pqi08_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))
summary(mod.nb_pqi08_1)
```  


#### Effect Modification  

We think there may be effect modification between % eligible for medicaid and expansion status, since in general Medicaid expansion means a higher percentage of the population qualifies for Medicaid.  

```{r}
mod.nb_pqi08_2 <- MASS::glm.nb(pqi08 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ percent_eligible_for_medicaid*expansion_status + offset(log(year)), data = pqi08_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))
summary(mod.nb_pqi08_2)
```  

The coefficients for the interaction are significant, so we will keep it in the model. 


#### Model Diagnostics  


```{r}
pqi08_data %>% 
  na.omit() %>% 
  ggplot(aes(x = pqi08, y = fitted(mod.nb_pqi08_2))) +
  geom_point(alpha = 0.7) +
  geom_smooth() +
  theme_bw()
```  

##### Check Poisson model  

```{r}
mod.pois_pqi08 <- glm(pqi08 ~ `expansion_status` + `percent_male` + `percent_african_american` + percent_hispanic + `percent_eligible_for_medicaid` + `age` + percent_eligible_for_medicaid_2+ percent_eligible_for_medicaid*expansion_status, offset = log(year), data = pqi08_data %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2), family = "poisson")

# Evaluate overdispersion
deviance(mod.pois_pqi08)/mod.pois_pqi08$df.residual #  98.75487
pearson.stat_pqi08 <- sum((na.omit(pqi08_data)$pqi08 - fitted(mod.pois_pqi08))^2/fitted(mod.pois_pqi08))
pearson.stat_pqi08/mod.pois_pqi08$df.residual # 99.92519

# Evidence of overdispersion 
mean(pqi08_data$pqi08, na.rm = T) #  1396.131
var(pqi08_data$pqi08, na.rm = T) # 669616.2
```  

By these, we can say the negative binomial is the right choice.   


#### Interpretation  

```{r}
coef(mod.nb_pqi08_2)
exp(confint(mod.nb_pqi08_2))
```  









