---
title: 'Section 4: Emergency Department Admissions Negative Binomial Model'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
medicare <- read_csv("data/medicare_2007_2018.csv")
medicare$expansion_status <- factor(medicare$expansion_status)
```  

We built a model to model the relationship between the emergency department visits per 1,000 beneficiaries and Medicaid Expansion status. For model selection, we started with the base model and added in potential covariates one by one from our list of potential covariates that did not have significant missingness in order to improve the model fit. We using likelihood ratio tests at each step to determine if adding the covariate was an appropriate addition to the model (checking the reduced model against the full model).


### Check distribution of outcome  

```{r}
medicare %>% 
  ggplot(aes(x= emergency_department_visits_per_1000_beneficiaries)) +
  geom_histogram(color = "black") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  xlab("Emergency Department Visits per 1,000 Beneficiaries") +
  ylab("Count") +
  ggtitle("Distribution of ED Visit Rates (2007-2018)") +
  theme_bw()
```  
The outcome looks pretty normally distributed.   

We next check for missingness in the outcome:  

```{r}
medicare %>% 
  select(emergency_department_visits_per_1000_beneficiaries) %>% 
  summarize_all(.funs = function(x) 
    return(paste0(round(sum(is.na(x))/length(x), 3)*100, "%"))) %>% 
  t() %>% data.frame() 
```


### Model Fitting    

#### Starting with our base model

```{r}
mod.nb_ed <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + offset(log(year)), data = medicare)
summary(mod.nb_ed)           

# Model diagnostics table
model_diagnostics <- data.frame(
  Model = "ED Visits ~ Exp",
  AIC = AIC(mod.nb_ed),
  BIC = BIC(mod.nb_ed)
)
```  

#### Improve Model Fit Using Other Covariates 

The covariates percent_male, percent_eligible_for_medicaid, average_age, do not satisfy the criteria for confounding the relationship between Medicaid Expansion status and Emergency Department Visit rates, so we will add each of these covariates one by one to determine if they improve the model fit using Likelihood Ratio tests.

###### Percent Male

```{r}
mod.nb_ed_c1 <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + percent_male + offset(log(year)), data = medicare)
summary(mod.nb_ed_c1)           

# Use Likelihood Ratio test to determine if confounder is necessary
anova(mod.nb_ed, mod.nb_ed_c1) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "ED Visits ~ Exp + Male",
    AIC = AIC(mod.nb_ed_c1),
    BIC = BIC(mod.nb_ed_c1)
    )
  )

```    
By the LRT, we do add in the effects of percent_male.  

###### Percent Eligible for Medicaid
```{r}
mod.nb_ed_c2 <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + offset(log(year)), data = medicare)
summary(mod.nb_ed_c2)           

# Use Anova to determine if confounder is necessary
anova(mod.nb_ed_c1, mod.nb_ed_c2) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "ED Visits ~ Exp + Male + % Elig",
    AIC = AIC(mod.nb_ed_c2),
    BIC = BIC(mod.nb_ed_c2)
    )
  )

```     
By the LRT, we do add in the effects of percent_eligible_for_medicaid.    

###### Average Age
```{r}
mod.nb_ed_c3 <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + offset(log(year)), data = medicare)
summary(mod.nb_ed_c3)           

# Use Likelihood ratio test to determine if covariate is necessary
anova(mod.nb_ed_c2, mod.nb_ed_c3) # Yes 
# # Model diagnostics table
model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "ED Visits ~ Exp + Male + % Elig + Age",
    AIC = AIC(mod.nb_ed_c3),
    BIC = BIC(mod.nb_ed_c3)
    )
  )
```  

By the LRT, we do add in the effects of average_age.    

##### Check for quadratic effects of `percent_eligible_for_medicaid`   
```{r}
mod.nb_ed_1 <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + percent_eligible_for_medicaid_2 + offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))

summary(mod.nb_ed_1)
anova(mod.nb_ed_c3, mod.nb_ed_1) # Yes 

model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "ED Visits ~ Exp + Male + % Elig + Age + % Elig^2",
    AIC = AIC(mod.nb_ed_1),
    BIC = BIC(mod.nb_ed_1)
    )
  )
```     
By the LRT, we do add in the quadratic effects of percent_eligible_for_medicaid.  

#### Effect Modification  

We think there may be effect modification between % eligible for medicaid and expansion status, since in general Medicaid expansion means a higher percentage of the population qualifies for Medicaid.  

```{r}
mod.nb_ed_2 <- MASS::glm.nb(emergency_department_visits_per_1000_beneficiaries ~ expansion_status + percent_male + percent_eligible_for_medicaid + average_age + percent_eligible_for_medicaid_2  + percent_eligible_for_medicaid*expansion_status+ offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2))
summary(mod.nb_ed_2)

anova(mod.nb_ed_1, mod.nb_ed_2)

model_diagnostics <- model_diagnostics %>% 
  bind_rows(
    data.frame(
    Model = "ED Visits ~ Exp + Male + % Elig + Age + % Elig^2 + % Elig*Exp",
    AIC = AIC(mod.nb_ed_2),
    BIC = BIC(mod.nb_ed_2)
    )
  )
```      
By the LRT, we do add the interaction between Medicaid expansion status and percent_eligible_for_medicaid.  


#### Model Diagnostics  


```{r}
model_diagnostics
```    

We hav ethe smallest AIC and BIC for the full model.

##### Check Poisson model  

```{r}
mod.pois_ed <- glm(emergency_department_visits_per_1000_beneficiaries ~ 
    expansion_status + percent_male + percent_eligible_for_medicaid + 
        average_age + percent_eligible_for_medicaid_2 + percent_eligible_for_medicaid * 
        expansion_status + offset(log(year)), data = medicare %>% mutate(percent_eligible_for_medicaid_2 = percent_eligible_for_medicaid^2), family = "poisson")

# Evaluate overdispersion
deviance(mod.pois_ed)/mod.pois_ed$df.residual #  19.99481
pearson.stat_ed <- sum((na.omit(medicare %>% select(percent_male, percent_eligible_for_medicaid, average_age,emergency_department_visits_per_1000_beneficiaries, expansion_status))$emergency_department_visits_per_1000_beneficiaries - fitted(mod.pois_ed))^2/fitted(mod.pois_ed))
pearson.stat_ed/mod.pois_ed$df.residual #  19.4187

# Evidence of overdispersion 
mean(medicare$emergency_department_visits_per_1000_beneficiaries, na.rm = T) # 664.9697
var(medicare$emergency_department_visits_per_1000_beneficiaries, na.rm = T) # 23235.82
```   

Since the ratio of the Pearson $\chi^2$ statistic and deviance to their respective degrees of freedom are greater than 1, the negative binomial model seems appropriate.  


#### Interpretation  
Output which is interpretated in the paper.

```{r}
exp(coef(mod.nb_ed_2))
exp(confint(mod.nb_ed_2))
```  









